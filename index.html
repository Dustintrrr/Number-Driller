<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Number Decoder</title>
  
  <!-- Fonts - ÁªßÊâø‰∏ªÁ´ôÂ≠ó‰ΩìÁ≥ªÁªü -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=DM+Sans:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
  
  <style>
    /* ========== DESIGN TOKENS - Claude Aesthetics ========== */
    :root {
      /* Ëâ≤ÂΩ©Á≥ªÁªü */
      --bg: #FDFBF7;
      --bg-secondary: #F5F0E8;
      --text-primary: #2D2926;
      --text-secondary: #6B635B;
      --text-tertiary: #9A958E;
      --accent: #C4A77D;
      --accent-light: rgba(196, 167, 125, 0.15);
      --error: #9A6458;
      --error-light: rgba(154, 100, 88, 0.1);
      --border: rgba(45, 41, 38, 0.1);
      --border-strong: rgba(45, 41, 38, 0.2);
      
      /* Â≠ó‰ΩìÁ≥ªÁªü */
      --font-serif: 'Cormorant Garamond', Georgia, serif;
      --font-sans: 'DM Sans', -apple-system, sans-serif;
      
      /* Èó¥Ë∑ù */
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      --space-2xl: 3rem;
      
      /* ËøáÊ∏° */
      --transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      --transition-fast: 0.2s ease;
      
      /* ÂÆâÂÖ®Âå∫Âüü */
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* ========== RESET & BASE ========== */
    *, *::before, *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html { height: 100%; }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ========== ANIMATIONS ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    /* ========== SCREEN SYSTEM ========== */
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      transition: opacity var(--transition), visibility var(--transition);
    }
    
    .screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* ========== HOME SCREEN ========== */
    .home-screen {
      justify-content: center;
      align-items: center;
      padding: var(--space-xl);
      padding-bottom: calc(var(--space-xl) + var(--safe-bottom));
      text-align: center;
    }
    
    .home-content {
      max-width: 320px;
      width: 100%;
    }
    
    /* Ê†áÈ¢òÂå∫Âüü */
    .home-title {
      font-family: var(--font-serif);
      font-size: clamp(2rem, 6vw, 2.5rem);
      font-weight: 300;
      letter-spacing: 0.04em;
      margin: 0 0 var(--space-xs);
      color: var(--text-primary);
      animation: slideUp 0.6s ease both;
    }
    
    .home-subtitle {
      font-family: var(--font-sans);
      font-size: 0.8rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin: 0 0 var(--space-2xl);
      animation: slideUp 0.6s ease 0.1s both;
    }
    
    /* ÂàÜÈöîÁ∫ø */
    .home-divider {
      width: 60px;
      height: 1px;
      background: var(--border-strong);
      margin: 0 auto var(--space-xl);
      animation: fadeIn 0.8s ease 0.3s both;
    }
    
    /* ÈöæÂ∫¶ÈÄâÊã© - ÂûÇÁõ¥ÂàóË°® */
    .level-list {
      list-style: none;
      padding: 0;
      margin: 0 0 var(--space-xl);
      animation: slideUp 0.6s ease 0.2s both;
    }
    
    .level-item {
      padding: var(--space-sm) var(--space-md);
      margin: 0;
      cursor: pointer;
      transition: all var(--transition-fast);
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .level-item:hover {
      background: var(--accent-light);
    }
    
    .level-item.active {
      background: var(--accent-light);
    }
    
    .level-item.active .level-name {
      color: var(--text-primary);
    }
    
    .level-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      width: 2px;
      height: 100%;
      background: var(--accent);
    }
    
    .level-item {
      position: relative;
    }
    
    .level-name {
      font-family: var(--font-serif);
      font-size: 1.1rem;
      font-weight: 400;
      color: var(--text-secondary);
      transition: color var(--transition-fast);
    }
    
    .level-meta {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      font-variant-numeric: tabular-nums;
    }
    
    /* ÂºÄÂßãÊåâÈíÆ */
    .start-btn {
      font-family: var(--font-sans);
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border-strong);
      padding: var(--space-sm) var(--space-lg);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
      letter-spacing: 0.05em;
      animation: slideUp 0.6s ease 0.4s both;
    }
    
    .start-btn:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }
    
    .start-btn:active {
      transform: scale(0.98);
    }
    
    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ËÆæÁΩÆÂÖ•Âè£ */
    .settings-link {
      margin-top: var(--space-xl);
      font-size: 0.75rem;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: color var(--transition-fast);
      animation: fadeIn 0.6s ease 0.5s both;
    }
    
    .settings-link:hover {
      color: var(--text-secondary);
    }

    /* ========== TRAINING SCREEN ========== */
    .training-screen {
      background: var(--bg);
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }
    
    /* È°∂ÈÉ®Ê†è */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--border);
    }
    
    .back-btn {
      font-size: 0.85rem;
      color: var(--text-tertiary);
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-xs);
      margin-left: -var(--space-xs);
      transition: color var(--transition-fast);
    }
    
    .back-btn:hover {
      color: var(--text-primary);
    }
    
    .top-meta {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .top-meta .type {
      color: var(--text-secondary);
    }
    
    /* HUD - ÊûÅÁÆÄ‰ø°ÊÅØÊù° */
    .hud-bar {
      display: flex;
      justify-content: center;
      gap: var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      font-size: 0.7rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 1px solid var(--border);
    }
    
    .hud-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .hud-value {
      font-variant-numeric: tabular-nums;
      color: var(--text-secondary);
    }
    
    /* ËøõÂ∫¶Êù° - ÊûÅÁªÜ */
    .progress-container {
      height: 2px;
      background: var(--bg-secondary);
    }
    
    .progress-bar {
      height: 100%;
      background: var(--accent);
      width: 100%;
      transition: none;
    }
    
    /* ‰∏ªÊòæÁ§∫Âå∫Âüü */
    .display-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl);
      min-height: 0;
    }
    
    .main-display {
      font-family: var(--font-serif);
      font-size: clamp(2.5rem, 10vw, 3.5rem);
      font-weight: 300;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.08em;
      min-height: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: color var(--transition);
    }
    
    .main-display.listening {
      color: var(--text-tertiary);
    }
    
    .main-display.correct {
      color: var(--accent);
    }
    
    .main-display.wrong {
      color: var(--error);
    }
    
    /* ÂÖâÊ†á */
    .cursor {
      display: inline-block;
      width: 2px;
      height: 2.5rem;
      background: var(--text-primary);
      margin-left: 2px;
      animation: pulse 1.2s ease-in-out infinite;
    }
    
    /* Âê¨Èü≥ÂõæÊ†á */
    .listening-icon {
      font-size: 2rem;
      animation: breathe 2s ease-in-out infinite;
    }
    
    /* ÂèçÈ¶àÂå∫Âüü */
    .feedback {
      min-height: 3rem;
      margin-top: var(--space-md);
      text-align: center;
    }
    
    .feedback-text {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: var(--space-xs);
    }
    
    .feedback-text.correct {
      color: var(--accent);
    }
    
    .feedback-text.wrong {
      color: var(--error);
    }
    
    .feedback-answer {
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }
    
    .feedback-answer .correct-val {
      color: var(--text-secondary);
      text-decoration: underline;
      text-decoration-color: var(--accent);
      text-underline-offset: 2px;
    }
    
    /* ÊéßÂà∂ÊåâÈíÆÂå∫ */
    .control-area {
      padding: var(--space-md) var(--space-lg);
      display: flex;
      justify-content: center;
    }
    
    .listen-btn {
      font-family: var(--font-sans);
      font-size: 0.8rem;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border);
      padding: var(--space-sm) var(--space-md);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .listen-btn:hover:not(:disabled) {
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }
    
    .listen-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .listen-btn .icon {
      font-size: 1rem;
    }

    /* ========== KEYPAD ========== */
    .keypad-container {
      background: var(--bg-secondary);
      padding: var(--space-md);
      padding-bottom: calc(var(--space-md) + var(--safe-bottom));
      border-top: 1px solid var(--border);
    }
    
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-xs);
      max-width: 280px;
      margin: 0 auto;
    }
    
    .key {
      aspect-ratio: 1.4;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: var(--font-serif);
      font-size: 1.4rem;
      font-weight: 400;
      color: var(--text-primary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .key:hover:not(:disabled) {
      background: var(--accent-light);
      border-color: var(--accent);
    }
    
    .key:active:not(:disabled) {
      transform: scale(0.97);
    }
    
    .key:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .key.delete {
      font-family: var(--font-sans);
      font-size: 1rem;
      color: var(--text-secondary);
    }
    
    /* Êèê‰∫§Ë°å */
    .submit-row {
      margin-top: var(--space-sm);
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .submit-btn {
      width: 100%;
      font-family: var(--font-sans);
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--bg);
      background: var(--text-primary);
      border: none;
      padding: var(--space-sm);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .submit-btn:hover:not(:disabled) {
      background: var(--text-secondary);
    }
    
    .submit-btn:disabled {
      background: var(--text-tertiary);
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ========== MODAL / OVERLAY ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(253, 251, 247, 0.95);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition);
      padding: var(--space-lg);
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: var(--bg);
      border: 1px solid var(--border);
      width: 100%;
      max-width: 360px;
      padding: var(--space-xl);
      border-radius: 8px;
      transform: translateY(20px);
      transition: transform var(--transition);
    }
    
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
    }
    
    .modal-header h2 {
      font-family: var(--font-serif);
      font-size: 1.25rem;
      font-weight: 400;
      margin: 0;
    }
    
    .modal-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: color var(--transition-fast);
    }
    
    .modal-close:hover {
      color: var(--text-primary);
    }

    /* ========== SPEED SETTINGS ========== */
    .speed-control {
      margin-bottom: var(--space-lg);
    }
    
    .speed-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .speed-value {
      font-variant-numeric: tabular-nums;
      color: var(--accent);
    }
    
    .speed-slider {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--bg-secondary);
      border-radius: 2px;
      outline: none;
    }
    
    .speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--text-primary);
      border-radius: 50%;
      cursor: pointer;
      transition: transform var(--transition-fast);
    }
    
    .speed-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }
    
    .speed-marks {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-xs);
      font-size: 0.7rem;
      color: var(--text-tertiary);
    }
    
    .preview-btn {
      width: 100%;
      font-size: 0.8rem;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: none;
      padding: var(--space-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-top: var(--space-md);
    }
    
    .preview-btn:hover {
      background: var(--accent-light);
    }
    
    .rate-info {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-align: center;
      margin-top: var(--space-md);
    }
    
    /* ========== ACCENT SELECTION ========== */
    .settings-section {
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-lg);
      border-bottom: 1px solid var(--border);
    }
    
    .settings-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: var(--space-sm);
    }
    
    .accent-options {
      display: flex;
      gap: var(--space-xs);
    }
    
    .accent-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: var(--space-sm);
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .accent-btn:hover {
      border-color: var(--border-strong);
    }
    
    .accent-btn.active {
      background: var(--accent-light);
      border-color: var(--accent);
    }
    
    .accent-flag {
      font-size: 1.2rem;
    }
    
    .accent-name {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    
    .accent-btn.active .accent-name {
      color: var(--text-primary);
    }

    /* ========== SUMMARY ========== */
    .summary-title {
      font-family: var(--font-serif);
      font-size: 1.5rem;
      font-weight: 300;
      text-align: center;
      margin-bottom: var(--space-lg);
    }
    
    .summary-stats {
      display: flex;
      justify-content: center;
      gap: var(--space-xl);
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-lg);
      border-bottom: 1px solid var(--border);
    }
    
    .summary-stat {
      text-align: center;
    }
    
    .summary-stat .value {
      font-family: var(--font-serif);
      font-size: 2rem;
      font-weight: 300;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }
    
    .summary-stat .label {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-top: var(--space-xs);
    }
    
    .summary-stat.highlight .value {
      color: var(--accent);
    }
    
    /* ÈîôÈ¢òÂàóË°® */
    .mistakes-section {
      margin-bottom: var(--space-lg);
    }
    
    .mistakes-title {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: var(--space-sm);
    }
    
    .mistake-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm);
      background: var(--error-light);
      border-radius: 4px;
      margin-bottom: var(--space-xs);
      font-size: 0.85rem;
    }
    
    .mistake-item .correct-answer {
      color: var(--text-primary);
    }
    
    .mistake-item .user-answer {
      color: var(--error);
      text-decoration: line-through;
    }
    
    .mistakes-more {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-align: center;
      padding: var(--space-xs);
    }
    
    /* Review Mode ÊåáÁ§∫Âô® */
    .review-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: 0.7rem;
      color: var(--accent);
      background: var(--accent-light);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: var(--space-sm);
    }
    
    /* Êìç‰ΩúÊåâÈíÆ */
    .summary-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .action-btn {
      width: 100%;
      font-family: var(--font-sans);
      font-size: 0.85rem;
      padding: var(--space-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .action-btn.primary {
      background: var(--text-primary);
      color: var(--bg);
      border: none;
    }
    
    .action-btn.primary:hover {
      background: var(--text-secondary);
    }
    
    .action-btn.secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    .action-btn.secondary:hover {
      border-color: var(--text-secondary);
    }

    /* ========== CALIBRATION ========== */
    .calibration-content {
      text-align: center;
    }
    
    .calibration-content h3 {
      font-family: var(--font-serif);
      font-size: 1.1rem;
      font-weight: 400;
      margin: 0 0 var(--space-xs);
    }
    
    .calibration-content p {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0 0 var(--space-lg);
    }
    
    .calibration-samples {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
    }
    
    .sample-btn {
      font-size: 0.85rem;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: none;
      padding: var(--space-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .sample-btn:hover {
      background: var(--accent-light);
    }
    
    .calibration-choices {
      display: flex;
      gap: var(--space-sm);
    }
    
    .choice-btn {
      flex: 1;
      font-size: 0.85rem;
      color: var(--bg);
      background: var(--text-primary);
      border: none;
      padding: var(--space-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .choice-btn:hover {
      background: var(--text-secondary);
    }
    
    .choice-btn.secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    .choice-btn.secondary:hover {
      border-color: var(--text-secondary);
      background: var(--accent-light);
    }
    
    .sample-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }
    
    .sample-icon {
      font-size: 1rem;
    }

    /* ========== UTILITIES ========== */
    .hidden {
      display: none !important;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-height: 650px) {
      .main-display {
        font-size: 2rem;
      }
      .key {
        aspect-ratio: 1.6;
        font-size: 1.2rem;
      }
    }
    
    @media (max-width: 360px) {
      .level-list {
        margin-bottom: var(--space-lg);
      }
      .home-title {
        font-size: 1.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- ========== HOME SCREEN ========== -->
  <div id="home-screen" class="screen home-screen">
    <div class="home-content">
      <h1 class="home-title">Number Decoder</h1>
      <p class="home-subtitle">Listening ¬∑ IELTS</p>
      
      <div class="home-divider"></div>
      
      <ul class="level-list" id="level-list">
        <li class="level-item active" data-level="1">
          <span class="level-name">Tourist</span>
          <span class="level-meta">0.6√ó</span>
        </li>
        <li class="level-item" data-level="2">
          <span class="level-name">Expat</span>
          <span class="level-meta">0.75√ó</span>
        </li>
        <li class="level-item" data-level="3">
          <span class="level-name">Native</span>
          <span class="level-meta">1.0√ó</span>
        </li>
        <li class="level-item" data-level="4">
          <span class="level-name">Spy</span>
          <span class="level-meta">1.15√ó</span>
        </li>
        <li class="level-item" data-level="5">
          <span class="level-name">Expert</span>
          <span class="level-meta">1.3√ó</span>
        </li>
      </ul>
      
      <button class="start-btn" id="start-btn">Begin</button>
      
      <div class="settings-link" id="settings-link">Speed Settings</div>
    </div>
  </div>

  <!-- ========== TRAINING SCREEN ========== -->
  <div id="training-screen" class="screen training-screen hidden">
    <div class="top-bar">
      <button class="back-btn" id="exit-btn">‚Üê Back</button>
      <div class="top-meta">
        <span class="type" id="question-type">--</span>
        <span> ¬∑ </span>
        <span id="question-level">L1</span>
      </div>
    </div>
    
    <div class="hud-bar">
      <div class="hud-item">
        <span>Accuracy</span>
        <span class="hud-value" id="hud-accuracy">--%</span>
      </div>
      <div class="hud-item">
        <span>Avg</span>
        <span class="hud-value" id="hud-time">--s</span>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar" id="time-bar"></div>
    </div>
    
    <div class="display-area">
      <div id="main-display" class="main-display">Press Listen</div>
      <div id="feedback" class="feedback"></div>
    </div>
    
    <div class="control-area">
      <button class="listen-btn" id="listen-btn">
        <span class="icon">‚ô™</span>
        <span id="listen-text">Listen</span>
      </button>
    </div>
    
    <div class="keypad-container">
      <div class="keypad" id="keypad">
        <button class="key" data-val="1">1</button>
        <button class="key" data-val="2">2</button>
        <button class="key" data-val="3">3</button>
        <button class="key" data-val="4">4</button>
        <button class="key" data-val="5">5</button>
        <button class="key" data-val="6">6</button>
        <button class="key" data-val="7">7</button>
        <button class="key" data-val="8">8</button>
        <button class="key" data-val="9">9</button>
        <button class="key" data-val=".">.</button>
        <button class="key" data-val="0">0</button>
        <button class="key delete" data-val="del">‚å´</button>
      </div>
      <div class="submit-row">
        <button class="submit-btn" id="submit-btn">Submit</button>
      </div>
    </div>
  </div>

  <!-- ========== SPEED MODAL ========== -->
  <div id="speed-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" id="close-speed-modal">√ó</button>
      </div>
      
      <!-- Âè£Èü≥ÈÄâÊã© -->
      <div class="settings-section">
        <div class="settings-label">Accent</div>
        <div class="accent-options" id="accent-options">
          <button class="accent-btn active" data-accent="en-US">
            <span class="accent-flag">üá∫üá∏</span>
            <span class="accent-name">American</span>
          </button>
          <button class="accent-btn" data-accent="en-GB">
            <span class="accent-flag">üá¨üáß</span>
            <span class="accent-name">British</span>
          </button>
          <button class="accent-btn" data-accent="en-AU">
            <span class="accent-flag">üá¶üá∫</span>
            <span class="accent-name">Australian</span>
          </button>
        </div>
      </div>
      
      <!-- ËØ≠ÈÄüÊéßÂà∂ -->
      <div class="speed-control">
        <div class="speed-label">
          <span>Speed Multiplier</span>
          <span class="speed-value" id="speed-display">1.0√ó</span>
        </div>
        <input type="range" class="speed-slider" id="speed-slider" min="0.5" max="1.5" step="0.05" value="1.0">
        <div class="speed-marks">
          <span>0.5√ó</span>
          <span>1.0√ó</span>
          <span>1.5√ó</span>
        </div>
      </div>
      
      <button class="preview-btn" id="preview-btn">Preview</button>
      
      <p class="rate-info">
        Final = Base √ó Multiplier<br>
        <span id="final-rate-info">0.60 √ó 1.00 = 0.60√ó</span>
      </p>
    </div>
  </div>

  <!-- ========== SUMMARY MODAL ========== -->
  <div id="summary-modal" class="modal-overlay">
    <div class="modal-content">
      <h2 class="summary-title">Session Complete</h2>
      
      <div class="summary-stats">
        <div class="summary-stat highlight">
          <div class="value" id="summary-accuracy">85%</div>
          <div class="label">Accuracy</div>
        </div>
        <div class="summary-stat">
          <div class="value" id="summary-time">2.8s</div>
          <div class="label">Avg Time</div>
        </div>
      </div>
      
      <div class="mistakes-section" id="mistakes-section">
        <div class="mistakes-title">Mistakes</div>
        <div id="mistakes-list"></div>
      </div>
      
      <div class="summary-actions">
        <button class="action-btn primary" id="continue-btn">Continue</button>
        <button class="action-btn secondary" id="back-home-btn">Back to Home</button>
      </div>
    </div>
  </div>

  <!-- ========== CALIBRATION MODAL ========== -->
  <div id="calibration-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Calibration</h2>
        <button class="modal-close" id="close-calib-modal">√ó</button>
      </div>
      <div class="calibration-content">
        <h3>Find Your Comfortable Speed</h3>
        <p>Listen to each sample and select the one that feels like natural conversation.</p>
        
        <div class="calibration-samples">
          <button class="sample-btn" id="sample-0-btn">
            <span class="sample-icon">‚ô™</span>
            <span>Fast (1.0√ó)</span>
          </button>
          <button class="sample-btn" id="sample-1-btn">
            <span class="sample-icon">‚ô™</span>
            <span>Normal (0.9√ó)</span>
          </button>
          <button class="sample-btn" id="sample-2-btn">
            <span class="sample-icon">‚ô™</span>
            <span>Moderate (0.8√ó)</span>
          </button>
          <button class="sample-btn" id="sample-3-btn">
            <span class="sample-icon">‚ô™</span>
            <span>Slow (0.7√ó)</span>
          </button>
        </div>
        
        <div class="calibration-choices">
          <button class="choice-btn" id="select-0-btn">Use Fast</button>
          <button class="choice-btn" id="select-1-btn">Use Normal</button>
        </div>
        <div class="calibration-choices" style="margin-top: var(--space-xs);">
          <button class="choice-btn secondary" id="select-2-btn">Use Moderate</button>
          <button class="choice-btn secondary" id="select-3-btn">Use Slow</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function() {
  'use strict';

  // ========== DIFFICULTY CONFIG ==========
  const DIFF = {
    1: { name: 'Tourist', baseRate: 0.60, phone: 3, price: [1, 50, false], year: [2015, 2024], pct: [50, false], filler: false, context: false, time: null },
    2: { name: 'Expat', baseRate: 0.75, phone: 4, price: [1, 100, true], year: [2000, 2024], pct: [100, false], filler: false, context: false, time: null },
    3: { name: 'Native', baseRate: 1.00, phone: 7, price: [1, 300, true], year: [1980, 2024], pct: [100, true], filler: false, context: false, time: 12 },
    4: { name: 'Spy', baseRate: 1.15, phone: 10, price: [1, 500, true], year: [1950, 2024], pct: [100, true], filler: true, context: false, time: 10 },
    5: { name: 'Expert', baseRate: 1.30, phone: 10, price: [1, 1000, true], year: [1900, 2024], pct: [100, true], filler: true, context: true, time: 8 }
  };

  const FILLERS = ["okay, ", "so, ", "um, ", "let me see, ", "right, "];
  const CTX = {
    phone: ["My number is ", "Call me at "],
    price: ["That'll be ", "The total is ", "It costs "],
    year: ["It was in ", "Back in "],
    percent: ["About ", "Around "]
  };

  // ========== STATE ==========
  const S = { 
    voiceState: 'LOCKED', 
    screen: 'HOME', 
    speaking: false, 
    level: 1, 
    mult: 1.0, 
    offset: 1.0, 
    session: null, 
    current: null, 
    input: '',
    reviewQueue: [],      // ÈîôÈ¢òÈáçÁªÉÈòüÂàó
    reviewMode: false,    // ÊòØÂê¶Â§Ñ‰∫éÈîôÈ¢òÈáçÁªÉÊ®°Âºè
    accent: 'en-US',      // Âè£Èü≥ÈÄâÊã©: en-US / en-GB / en-AU
    recentHistory: []     // Á≤æÁ°ÆÊªëÂä®Á™óÂè£ÔºöÊúÄËøë30È¢òËÆ∞ÂΩï [{type, ok}]
  };
  
  // Âè£Èü≥ÈÖçÁΩÆ
  const ACCENTS = {
    'en-US': { name: 'American', lang: 'en-US', flag: 'üá∫üá∏' },
    'en-GB': { name: 'British', lang: 'en-GB', flag: 'üá¨üáß' },
    'en-AU': { name: 'Australian', lang: 'en-AU', flag: 'üá¶üá∫' }
  };

  // ========== STORAGE ==========
  const Store = {
    get(k, d) { try { const v = localStorage.getItem('nd_' + k); return v ? JSON.parse(v) : d; } catch { return d; } },
    set(k, v) { try { localStorage.setItem('nd_' + k, JSON.stringify(v)); } catch {} }
  };

  // ========== PHONETICS (with pronunciation variants) ==========
  const Ph = {
    o: ['zero','one','two','three','four','five','six','seven','eight','nine'],
    // Ëã±ÂºèÂèëÈü≥Âèò‰ΩìÔºö0 ÂèØËØª "oh" Êàñ "zero"
    oAlt: ['oh','one','two','three','four','five','six','seven','eight','nine'],
    t: ['ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'],
    d: ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'],
    
    // Âü∫Á°ÄÊï∞Â≠óËΩ¨Êç¢
    w(n) { 
      n = +n; 
      if (n < 10) return this.o[n]; 
      if (n < 20) return this.t[n - 10]; 
      const a = n / 10 | 0, b = n % 10; 
      return b ? this.d[a] + ' ' + this.o[b] : this.d[a]; 
    },
    
    h(n) { 
      n = +n; 
      if (n < 100) return this.w(n); 
      const a = n / 100 | 0, b = n % 100; 
      return b ? this.o[a] + ' hundred ' + this.w(b) : this.o[a] + ' hundred'; 
    },
    
    // ===== ÁîµËØùÂè∑Á†Å - ÊîØÊåÅ double/triple Âèò‰Ωì =====
    phone(d) {
      // ÈöèÊú∫ÈÄâÊã©ËØªÊ≥ïÈ£éÊ†º
      const style = Math.random();
      
      if (style < 0.4) {
        // È£éÊ†º1: Ê†áÂáÜÈÄê‰ΩçËØªÔºà40%Ê¶ÇÁéáÔºâ
        return this.phoneStandard(d);
      } else if (style < 0.7) {
        // È£éÊ†º2: ‰ΩøÁî® double/tripleÔºà30%Ê¶ÇÁéáÔºâ
        return this.phoneGrouped(d);
      } else {
        // È£éÊ†º3: ‰ΩøÁî® "oh" Êõø‰ª£ "zero"Ôºà30%Ê¶ÇÁéáÔºâ
        return this.phoneWithOh(d);
      }
    },
    
    // Ê†áÂáÜÈÄê‰ΩçËØª
    phoneStandard(d) {
      if (d.length <= 4) return d.split('').map(x => this.o[+x]).join(', ');
      if (d.length <= 7) return d.slice(0, 3).split('').map(x => this.o[+x]).join(' ') + ', ' + d.slice(3).split('').map(x => this.o[+x]).join(' ');
      return d.slice(0, 3).split('').map(x => this.o[+x]).join(' ') + ', ' + d.slice(3, 6).split('').map(x => this.o[+x]).join(' ') + ', ' + d.slice(6).split('').map(x => this.o[+x]).join(' ');
    },
    
    // ‰ΩøÁî® "oh" Êõø‰ª£ "zero"
    phoneWithOh(d) {
      const arr = d.length <= 4 ? this.oAlt : this.oAlt;
      if (d.length <= 4) return d.split('').map(x => arr[+x]).join(', ');
      if (d.length <= 7) return d.slice(0, 3).split('').map(x => arr[+x]).join(' ') + ', ' + d.slice(3).split('').map(x => arr[+x]).join(' ');
      return d.slice(0, 3).split('').map(x => arr[+x]).join(' ') + ', ' + d.slice(3, 6).split('').map(x => arr[+x]).join(' ') + ', ' + d.slice(6).split('').map(x => arr[+x]).join(' ');
    },
    
    // ‰ΩøÁî® double/triple ÂàÜÁªÑ
    phoneGrouped(d) {
      const segments = [];
      let i = 0;
      
      // Êåâ3-3-4Êàñ3-4ÊàñËá™ÁÑ∂ÂàÜÊÆµ
      if (d.length === 10) {
        segments.push(d.slice(0, 3), d.slice(3, 6), d.slice(6));
      } else if (d.length === 7) {
        segments.push(d.slice(0, 3), d.slice(3));
      } else {
        segments.push(d);
      }
      
      return segments.map(seg => this.groupDigits(seg)).join(', ');
    },
    
    // ÂàÜÊûêËøûÁª≠Áõ∏ÂêåÊï∞Â≠óÔºå‰ΩøÁî® double/triple
    groupDigits(s) {
      const result = [];
      let i = 0;
      
      while (i < s.length) {
        let count = 1;
        while (i + count < s.length && s[i] === s[i + count] && count < 3) {
          count++;
        }
        
        const digit = +s[i];
        if (count === 3) {
          result.push('triple ' + this.o[digit]);
        } else if (count === 2) {
          result.push('double ' + this.o[digit]);
        } else {
          // ÈöèÊú∫‰ΩøÁî® oh Êõø‰ª£ zero
          result.push(digit === 0 && Math.random() > 0.5 ? 'oh' : this.o[digit]);
        }
        i += count;
      }
      
      return result.join(' ');
    },
    
    // ===== ‰ª∑Ê†º =====
    price(dol, cen) { 
      let s = this.h(dol) + ' dollar' + (dol !== 1 ? 's' : ''); 
      if (cen > 0) s += ' and ' + this.w(cen) + ' cent' + (cen !== 1 ? 's' : ''); 
      return s; 
    },
    
    // ===== Âπ¥‰ªΩ - ÊîØÊåÅÂ§öÁßçËØªÊ≥ï =====
    year(y) {
      // ÈöèÊú∫ÈÄâÊã©ËØªÊ≥ïÈ£éÊ†º
      const style = Math.random();
      
      if (style < 0.7) {
        // 70% Ê¶ÇÁéáÔºöÊ†áÂáÜÂπ¥‰ªΩËØªÊ≥ï
        return this.yearStandard(y);
      } else {
        // 30% Ê¶ÇÁéáÔºöÈÄê‰ΩçËØªÊ≥ï
        return this.yearDigitByDigit(y);
      }
    },
    
    // Ê†áÂáÜÂπ¥‰ªΩËØªÊ≥ïÔºàÂ¶Ç 1990 ‚Üí nineteen ninetyÔºâ
    yearStandard(y) {
      if (y >= 2000 && y <= 2009) return y === 2000 ? 'two thousand' : 'two thousand ' + this.o[y - 2000];
      if (y >= 2010 && y <= 2019) return 'twenty ' + this.t[y - 2010];
      if (y >= 2020) return 'twenty ' + this.w(y % 100);
      const c = y / 100 | 0, r = y % 100;
      if (r === 0) return this.w(c) + ' hundred';
      if (r < 10) return this.w(c) + ' oh ' + this.o[r];
      return this.w(c) + ' ' + this.w(r);
    },
    
    // ÈÄê‰ΩçËØªÊ≥ïÔºàÂ¶Ç 1990 ‚Üí one nine nine zeroÔºâ
    yearDigitByDigit(y) {
      const s = String(y);
      // ‰ΩøÁî® "oh" Êõø‰ª£ÈÉ®ÂàÜ "zero"
      return s.split('').map(x => +x === 0 && Math.random() > 0.5 ? 'oh' : this.o[+x]).join(' ');
    },
    
    // ===== ÁôæÂàÜÊØî =====
    pct(v) { 
      const p = String(v).split('.'); 
      let s = this.w(+p[0]); 
      if (p[1] && +p[1] > 0) s += ' point ' + p[1].split('').map(x => this.o[+x]).join(' '); 
      return s + ' percent'; 
    }
  };

  // ========== FACTORY ==========
  const F = {
    // Âä®ÊÄÅËÆ°Êó∂ÔºöÊ†πÊçÆÊï∞Â≠ó‰ΩçÊï∞ËÆ°ÁÆóÂêàÁêÜ‰ΩúÁ≠îÊó∂Èó¥
    calcTime(q, level) {
      const c = DIFF[level];
      if (!c.time) return null;  // Level 1-2 Êó†ËÆ°Êó∂
      
      // Âü∫Á°ÄÊó∂Èó¥ + ÊØè‰ΩçÊï∞Â≠óÈ¢ùÂ§ñÊó∂Èó¥
      const digits = q.raw.replace(/[^0-9]/g, '').length;
      const baseTime = c.time * 0.6;  // Âü∫Á°ÄÊó∂Èó¥‰∏∫ÂéüËÆæÂÆöÁöÑ60%
      const perDigit = 0.8;            // ÊØè‰ΩçÊï∞Â≠ó0.8Áßí
      const calculated = baseTime + (digits * perDigit);
      
      // ÈôêÂà∂Âú®ÂêàÁêÜËåÉÂõ¥ÂÜÖ
      return Math.min(Math.max(calculated, c.time * 0.7), c.time * 1.5);
    },
    
    // Âº±È°πÂä†ÊùÉÈÄâÈ¢ò - Âü∫‰∫éÊúÄËøë30È¢òÁöÑÁ≤æÁ°ÆÊªëÂä®Á™óÂè£
    pickType() {
      const types = ['phone', 'price', 'year', 'percent'];
      const history = Store.get('recentHistory', []);
      
      // ÁªüËÆ°ÊúÄËøë30È¢òÂêÑÈ¢òÂûãÁöÑÈîôËØØÁéá
      const stats = {};
      types.forEach(t => stats[t] = { ok: 0, total: 0 });
      
      history.slice(-30).forEach(h => {
        if (stats[h.type]) {
          stats[h.type].total++;
          if (h.ok) stats[h.type].ok++;
        }
      });
      
      // ËÆ°ÁÆóÂêÑÈ¢òÂûãÁöÑ"Âº±È°πÂàÜÊï∞"ÔºàÈîôËØØÁéáË∂äÈ´òÔºåÂàÜÊï∞Ë∂äÈ´òÔºâ
      const weights = types.map(t => {
        const s = stats[t];
        if (s.total < 3) return 1;  // Ê†∑Êú¨‰∏çË∂≥Êó∂ÂùáÁ≠âÊ¶ÇÁéá
        const errorRate = 1 - (s.ok / s.total);
        // ÊùÉÈáçÂÖ¨ÂºèÔºöÂü∫Á°Ä1 + ÈîôËØØÁéá*3ÔºåÈîôËØØÁéá50%Êó∂ÊùÉÈáç2.5
        return 1 + (errorRate * 3);
      });
      
      // Âä†ÊùÉÈöèÊú∫ÈÄâÊã©
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      let r = Math.random() * totalWeight;
      for (let i = 0; i < types.length; i++) {
        r -= weights[i];
        if (r <= 0) return types[i];
      }
      return types[0];
    },
    
    // ËÆ∞ÂΩïÁ≠îÈ¢òÂéÜÂè≤ÔºàÊªëÂä®Á™óÂè£Ôºâ
    recordHistory(type, ok) {
      const history = Store.get('recentHistory', []);
      history.push({ type, ok, ts: Date.now() });
      // Âè™‰øùÁïôÊúÄËøë50Êù°ÔºàÁªô‰∏Ä‰∫õ‰ΩôÈáèÔºâ
      if (history.length > 50) history.shift();
      Store.set('recentHistory', history);
      S.recentHistory = history;
    },
    
    gen(lv, tp) {
      const c = DIFF[lv];
      tp = tp || this.pickType();  // ‰ΩøÁî®Âº±È°πÂä†ÊùÉÈÄâÈ¢ò
      let q;
      if (tp === 'phone') { let d = ''; for (let i = 0; i < c.phone; i++) d += Math.random() * 10 | 0; let disp = d; if (d.length === 7) disp = d.slice(0,3) + '-' + d.slice(3); else if (d.length === 10) disp = '(' + d.slice(0,3) + ') ' + d.slice(3,6) + '-' + d.slice(6); q = { raw: d, display: disp, spoken: Ph.phone(d) }; }
      else if (tp === 'price') { const dol = (Math.random() * (c.price[1] - c.price[0]) | 0) + c.price[0]; const cen = c.price[2] ? Math.random() * 100 | 0 : 0; const raw = cen > 0 ? dol + '.' + String(cen).padStart(2, '0') : String(dol); q = { raw, display: '$' + raw, spoken: Ph.price(dol, cen) }; }
      else if (tp === 'year') { const y = (Math.random() * (c.year[1] - c.year[0] + 1) | 0) + c.year[0]; q = { raw: String(y), display: String(y), spoken: Ph.year(y) }; }
      else { let v; if (c.pct[1] && Math.random() > 0.5) v = (Math.random() * c.pct[0]).toFixed(1); else v = String((Math.random() * c.pct[0] | 0) + 1); q = { raw: v, display: v + '%', spoken: Ph.pct(v) }; }
      q.type = tp; q.level = lv;
      if (c.filler && Math.random() < 0.5) q.spoken = FILLERS[Math.random() * FILLERS.length | 0] + q.spoken;
      if (c.context && Math.random() < 0.6) q.spoken = CTX[tp][Math.random() * CTX[tp].length | 0] + q.spoken;
      return q;
    }
  };

  // ========== AUDIO ==========
  const A = {
    syn: window.speechSynthesis, 
    voice: null,
    voices: {},  // ÁºìÂ≠òÂêÑÂè£Èü≥ÁöÑ voice
    
    init() {
      return new Promise(r => {
        const check = () => { 
          const v = this.syn.getVoices(); 
          if (v.length) { 
            // ‰∏∫ÊØèÁßçÂè£Èü≥ÊâæÂà∞ÊúÄ‰Ω≥ voice
            ['en-US', 'en-GB', 'en-AU'].forEach(lang => {
              // ‰ºòÂÖàÈÄâÊã©ËØ•ËØ≠Ë®ÄÁöÑÂéüÁîü voice
              this.voices[lang] = v.find(x => x.lang === lang) 
                || v.find(x => x.lang.startsWith(lang.split('-')[0])) 
                || v[0];
            });
            // ËÆæÁΩÆÂΩìÂâç voice
            this.voice = this.voices[S.accent] || this.voices['en-US'] || v[0];
            r(true); 
          } else {
            setTimeout(check, 100);
          }
        };
        this.syn.onvoiceschanged = check; 
        check(); 
        setTimeout(() => r(true), 2000);
      });
    },
    
    // ÂàáÊç¢Âè£Èü≥
    setAccent(accent) {
      if (this.voices[accent]) {
        this.voice = this.voices[accent];
        S.accent = accent;
        const p = Store.get('prefs', {});
        p.accent = accent;
        Store.set('prefs', p);
      }
    },
    
    // Ëé∑ÂèñÂèØÁî®Âè£Èü≥ÂàóË°®
    getAvailableAccents() {
      return Object.keys(this.voices).filter(k => this.voices[k]);
    },
    
    unlock() { 
      S.voiceState = 'UNLOCKING'; 
      return this.init().then(() => this.speak('ready', 1, true)).then(ok => { 
        S.voiceState = ok ? 'READY' : 'ERROR'; 
        return ok; 
      }); 
    },
    
    speak(text, rate, silent) {
      return new Promise(r => {
        try {
          this.syn.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.lang = S.accent; 
          u.volume = silent ? 0.01 : 1;
          if (this.voice) u.voice = this.voice;
          u.rate = rate;
          let done = false; 
          const fin = ok => { if (!done) { done = true; r(ok); } };
          u.onend = () => fin(true); 
          u.onerror = () => fin(false); 
          setTimeout(() => fin(false), 15000);
          window.__u = u; 
          this.syn.speak(u);
        } catch { r(false); }
      });
    },
    
    play(text, rate) {
      if (S.voiceState !== 'READY' || S.speaking) return Promise.resolve(false);
      S.speaking = true; UI.render();
      return new Promise(r => setTimeout(r, 50)).then(() => this.speak(text, rate, false)).then(ok => { S.speaking = false; UI.render(); return ok; });
    }
  };

  // ========== UI ==========
  const UI = {
    el: {},
    init() {
      this.el = {
        home: document.getElementById('home-screen'),
        train: document.getElementById('training-screen'),
        levelList: document.getElementById('level-list'),
        start: document.getElementById('start-btn'),
        settings: document.getElementById('settings-link'),
        acc: document.getElementById('hud-accuracy'),
        time: document.getElementById('hud-time'),
        bar: document.getElementById('time-bar'),
        listen: document.getElementById('listen-btn'),
        listenText: document.getElementById('listen-text'),
        submit: document.getElementById('submit-btn'),
        qType: document.getElementById('question-type'),
        qLevel: document.getElementById('question-level'),
        display: document.getElementById('main-display'),
        fb: document.getElementById('feedback'),
        keypad: document.getElementById('keypad'),
        slider: document.getElementById('speed-slider'),
        spdDisp: document.getElementById('speed-display'),
        rateInfo: document.getElementById('final-rate-info')
      };
      this.load();
    },
    load() {
      const p = Store.get('prefs', {});
      S.mult = p.mult || 1.0;
      S.offset = p.offset || 1.0;
      S.level = p.level || 1;
      S.accent = p.accent || 'en-US';
      S.recentHistory = Store.get('recentHistory', []);
      this.updateLevelUI();
      this.updateAccentUI();
      this.updateRate();
    },
    updateAccentUI() {
      document.querySelectorAll('.accent-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.accent === S.accent);
      });
    },
    updateLevelUI() {
      this.el.levelList.querySelectorAll('.level-item').forEach(item => {
        item.classList.toggle('active', +item.dataset.level === S.level);
      });
    },
    updateRate() {
      const c = DIFF[S.level];
      const r = (c.baseRate * S.mult * S.offset).toFixed(2);
      if (this.el.rateInfo) {
        this.el.rateInfo.textContent = c.baseRate.toFixed(2) + ' √ó ' + S.mult.toFixed(2) + ' = ' + r + '√ó';
      }
    },
    show(n) {
      this.el.home.classList.toggle('hidden', n !== 'HOME');
      this.el.train.classList.toggle('hidden', n !== 'TRAIN');
      S.screen = n;
    },
    modal(id, show) {
      document.getElementById(id).classList.toggle('active', show);
    },
    render() {
      const sess = S.session, curr = S.current;
      
      // HUD
      if (sess && sess.att.length) {
        this.el.acc.textContent = (sess.ok / sess.att.length * 100 | 0) + '%';
        this.el.time.textContent = (sess.att.reduce((a, b) => a + b.t, 0) / sess.att.length / 1000).toFixed(1) + 's';
      }
      
      // Level info + Review mode indicator
      const c = DIFF[S.level];
      let levelText = c.name;
      if (S.reviewMode && S.reviewQueue.length > 0) {
        levelText = c.name + ' <span class="review-badge">' + (S.reviewQueue.length + 1) + ' left</span>';
      } else if (S.reviewMode) {
        levelText = c.name + ' <span class="review-badge">Review</span>';
      }
      this.el.qLevel.innerHTML = levelText;
      
      // Main display
      if (curr) {
        this.el.qType.textContent = curr.type.toUpperCase();
        const d = this.el.display;
        d.classList.remove('listening', 'correct', 'wrong');
        
        if (S.speaking) {
          d.classList.add('listening');
          d.innerHTML = '<span class="listening-icon">‚ô™</span>';
        } else if (curr.done) {
          d.classList.add(curr.ok ? 'correct' : 'wrong');
          d.textContent = curr.ok ? S.input : S.input || '‚Äî';
          this.el.fb.innerHTML = curr.ok 
            ? '<div class="feedback-text correct">Correct</div>'
            : '<div class="feedback-text wrong">Incorrect</div><div class="feedback-answer">Answer: <span class="correct-val">' + curr.display + '</span></div>';
        } else if (curr.heard) {
          d.innerHTML = S.input ? S.input + '<span class="cursor"></span>' : '<span class="cursor"></span>';
          this.el.fb.innerHTML = '';
        } else {
          d.textContent = 'Press Listen';
          this.el.fb.innerHTML = '';
        }
      } else {
        this.el.display.textContent = 'Press Listen';
        this.el.fb.innerHTML = '';
      }
      
      // Listen button text
      if (curr && curr.heard && !curr.done) {
        this.el.listenText.textContent = 'Replay';
      } else if (curr && curr.done) {
        this.el.listenText.textContent = 'Next';
      } else {
        this.el.listenText.textContent = 'Listen';
      }
      
      // Button states
      const canListen = S.voiceState === 'READY' && !S.speaking;
      this.el.listen.disabled = !canListen;
      this.el.submit.disabled = !(!S.speaking && curr && curr.heard && !curr.done && S.input.length);
      this.el.keypad.querySelectorAll('.key').forEach(k => {
        k.disabled = S.speaking || (curr && curr.done);
      });
      
      // Speed display
      this.el.spdDisp.textContent = S.mult.toFixed(2) + '√ó';
      this.el.slider.value = S.mult;
      this.updateRate();
    },
    summary() {
      const sess = S.session;
      const acc = sess.att.length ? (sess.ok / sess.att.length * 100 | 0) : 0;
      
      document.getElementById('summary-accuracy').textContent = acc + '%';
      document.getElementById('summary-time').textContent = sess.att.length 
        ? (sess.att.reduce((a, b) => a + b.t, 0) / sess.att.length / 1000).toFixed(1) + 's' 
        : '-';
      
      const list = document.getElementById('mistakes-list');
      list.innerHTML = '';
      
      // Êõ¥Êñ∞ Continue ÊåâÈíÆÊñáÂ≠ó
      const continueBtn = document.getElementById('continue-btn');
      if (sess.mis.length) {
        document.getElementById('mistakes-section').classList.remove('hidden');
        continueBtn.textContent = 'Practice ' + sess.mis.length + ' Wrong';
        sess.mis.slice(0, 5).forEach(m => {
          const div = document.createElement('div');
          div.className = 'mistake-item';
          div.innerHTML = '<span class="correct-answer">' + m.display + '</span><span class="user-answer">' + (m.userInput || '‚Äî') + '</span>';
          list.appendChild(div);
        });
        if (sess.mis.length > 5) {
          const more = document.createElement('div');
          more.className = 'mistakes-more';
          more.textContent = '+' + (sess.mis.length - 5) + ' more';
          list.appendChild(more);
        }
      } else {
        document.getElementById('mistakes-section').classList.add('hidden');
        continueBtn.textContent = 'Continue';
      }
      
      // Â¶ÇÊûúÊòØÈîôÈ¢òÈáçÁªÉÊ®°ÂºèÔºåÊòæÁ§∫ÁâπÊÆäÊ†áÈ¢ò
      const title = document.querySelector('.summary-title');
      if (S.reviewMode) {
        title.textContent = 'Review Complete';
      } else {
        title.textContent = 'Session Complete';
      }
      
      this.modal('summary-modal', true);
    },
    
    // Ê†°ÂáÜÁïåÈù¢Êõ¥Êñ∞
    updateCalibrationUI(data) {
      // Â¶ÇÊûúÈúÄË¶ÅÊõ¥Êñ∞Ê†°ÂáÜÁïåÈù¢ÁöÑÁä∂ÊÄÅÔºåÂèØ‰ª•Âú®ËøôÈáåÂÆûÁé∞
    }
  };

  // ========== APP ==========
  const App = {
    timer: null,
    calibrationData: null,  // Êô∫ËÉΩÊ†°ÂáÜÊï∞ÊçÆ
    
    start() {
      UI.el.start.disabled = true;
      UI.el.start.textContent = 'Loading...';
      const p = Store.get('prefs', {});
      S.mult = p.mult || 1.0;
      S.offset = p.offset || 1.0;
      
      A.unlock().then(ok => {
        if (ok) {
          if (!p.calibrated) {
            this.startSmartCalibration();
          } else {
            this.begin();
          }
        } else {
          UI.el.start.disabled = false;
          UI.el.start.textContent = 'Retry';
        }
      });
    },
    
    // ===== Êô∫ËÉΩÊ†°ÂáÜÔºàÈò∂Ê¢ØÊ≥ïÔºâ=====
    startSmartCalibration() {
      this.calibrationData = {
        step: 0,
        rates: [1.0, 0.9, 0.8, 0.7],  // ÊµãËØïËØ≠ÈÄü
        currentRateIndex: 0,
        results: [],
        questions: [
          { spoken: 'forty five dollars and ninety nine cents', answer: '45.99' },
          { spoken: 'the year two thousand twenty three', answer: '2023' },
          { spoken: 'three one four, five nine two', answer: '314592' },
          { spoken: 'seventeen point five percent', answer: '17.5' },
          { spoken: 'eighty seven dollars', answer: '87' },
          { spoken: 'one nine eight five', answer: '1985' },
          { spoken: 'six four nine, two seven three, eight zero one zero', answer: '6492738010' },
          { spoken: 'thirty two point eight percent', answer: '32.8' },
          { spoken: 'two hundred fifteen dollars and fifty cents', answer: '215.50' },
          { spoken: 'the year nineteen ninety six', answer: '1996' }
        ]
      };
      UI.modal('calibration-modal', true);
      UI.updateCalibrationUI(this.calibrationData);
    },
    
    playCalibSample(idx) {
      if (S.speaking) return;
      const cd = this.calibrationData;
      if (!cd) return;
      const rate = cd.rates[idx];
      A.play('The total is forty five dollars', rate);
    },
    
    selectCalibSpeed(rateIndex) {
      const cd = this.calibrationData;
      if (!cd) return;
      
      // Ê†πÊçÆÈÄâÊã©ËÆæÁΩÆ offset
      const offsets = [1.0, 0.95, 0.9, 0.85];
      S.offset = offsets[rateIndex];
      
      const p = Store.get('prefs', {});
      p.offset = S.offset;
      p.calibrated = true;
      Store.set('prefs', p);
      
      UI.modal('calibration-modal', false);
      this.calibrationData = null;
      this.begin();
    },
    
    begin(reviewMode = false) {
      S.reviewMode = reviewMode;
      
      if (reviewMode && S.session && S.session.mis.length > 0) {
        // ÈîôÈ¢òÈáçÁªÉÊ®°ÂºèÔºöÂ∞ÜÈîôÈ¢òÂä†ÂÖ•ÈòüÂàó
        S.reviewQueue = S.session.mis.map(q => ({
          ...q,
          heard: false,
          done: false,
          ok: null,
          userInput: null
        }));
      } else {
        S.reviewQueue = [];
      }
      
      S.session = { att: [], ok: 0, streak: 0, best: 0, mis: [] };
      S.current = null;
      S.input = '';
      UI.show('TRAIN');
      UI.render();
    },
    
    rate() {
      return DIFF[S.level].baseRate * S.mult * S.offset;
    },
    
    handleListen() {
      const curr = S.current;
      
      // Next question after completion
      if (curr && curr.done) {
        this.next();
        return;
      }
      
      // Replay
      if (curr && curr.heard && !curr.done) {
        this.replay();
        return;
      }
      
      // New question
      this.listen();
    },
    
    listen() {
      if (S.speaking || S.voiceState !== 'READY') return;
      
      let q;
      if (S.reviewMode && S.reviewQueue.length > 0) {
        // ‰ªéÈîôÈ¢òÈòüÂàóÂèñÈ¢ò
        q = S.reviewQueue.shift();
      } else {
        // ÁîüÊàêÊñ∞È¢ò
        q = F.gen(S.level);
      }
      
      q.heard = false;
      q.done = false;
      q.ok = null;
      S.current = q;
      S.input = '';
      UI.render();
      
      A.play(q.spoken, this.rate()).then(ok => {
        if (ok) {
          q.heard = true;
          q.at = Date.now();
          
          // ‰ΩøÁî®Âä®ÊÄÅËÆ°Êó∂
          const dynamicTime = F.calcTime(q, S.level);
          if (dynamicTime) this.startTimer(dynamicTime);
        }
        UI.render();
      });
    },
    
    replay() {
      const q = S.current;
      if (!q || q.done || S.speaking) return;
      A.play(q.spoken, this.rate());
    },
    
    next() {
      if (!S.current || !S.current.done) return;
      
      // Ê£ÄÊü•ÈîôÈ¢òÈáçÁªÉÊ®°ÂºèÊòØÂê¶ÂÆåÊàê
      if (S.reviewMode && S.reviewQueue.length === 0 && S.session.att.length > 0) {
        // ÈîôÈ¢òÈáçÁªÉÂÆåÊàêÔºåÂèØ‰ª•ÈÄâÊã©ÁªßÁª≠ÊàñÁªìÊùü
        // ËøôÈáåÁªßÁª≠Âá∫Êñ∞È¢òÁõ¥Âà∞Áî®Êà∑ÈÄÄÂá∫
        S.reviewMode = false;
      }
      
      S.current = null;
      S.input = '';
      UI.render();
      this.listen();
    },
    
    input(v) {
      if (S.speaking || !S.current || S.current.done) return;
      if (v === 'del') {
        S.input = S.input.slice(0, -1);
      } else if (v === '.' && !S.input.includes('.')) {
        S.input += v;
      } else if (v !== '.' && S.input.length < 15) {
        S.input += v;
      }
      UI.render();
    },
    
    submit() {
      const q = S.current;
      if (!q || q.done || !S.input.length) return;
      
      this.clearTimer();
      
      let a = S.input.replace(/[^0-9.]/g, '');
      let b = q.raw.replace(/[^0-9.]/g, '');
      const ok = (q.type === 'price' || q.type === 'percent') ? parseFloat(a) === parseFloat(b) : a === b;
      
      q.done = true;
      q.ok = ok;
      q.userInput = S.input;
      
      S.session.att.push({ ok, t: Date.now() - q.at, type: q.type });
      
      // ËÆ∞ÂΩïÂà∞ÊªëÂä®Á™óÂè£ÔºàÂº±È°πÂä†ÊùÉÔºâ
      F.recordHistory(q.type, ok);
      
      if (ok) {
        S.session.ok++;
        S.session.streak++;
        S.session.best = Math.max(S.session.best, S.session.streak);
      } else {
        S.session.streak = 0;
        S.session.mis.push(q);
      }
      
      UI.render();
    },
    
    startTimer(sec) {
      this.clearTimer();
      const b = UI.el.bar;
      b.style.width = '100%';
      b.style.transition = 'none';
      requestAnimationFrame(() => {
        b.style.transition = 'width ' + sec + 's linear';
        b.style.width = '0%';
      });
      this.timer = setTimeout(() => {
        if (S.current && !S.current.done) this.submit();
      }, sec * 1000);
    },
    
    clearTimer() {
      if (this.timer) {
        clearTimeout(this.timer);
        this.timer = null;
      }
      UI.el.bar.style.transition = 'none';
      UI.el.bar.style.width = '100%';
    },
    
    exit() {
      this.clearTimer();
      A.syn.cancel();
      S.speaking = false;
      
      const sess = S.session;
      if (sess && sess.att.length) {
        const acc = sess.ok / sess.att.length;
        const s = Store.get('sessions', []);
        s.unshift({ acc, count: sess.att.length, level: S.level, ts: Date.now(), reviewMode: S.reviewMode });
        if (s.length > 20) s.pop();
        Store.set('sessions', s);
        
        const p = Store.get('prefs', {});
        p.level = S.level;
        p.mult = S.mult;
        Store.set('prefs', p);
        
        UI.summary();
      } else {
        this.home();
      }
    },
    
    closeSummary() {
      UI.modal('summary-modal', false);
      this.home();
    },
    
    // ÁªÉ‰π†ÈîôÈ¢ò
    practiceWrong() {
      if (S.session && S.session.mis.length > 0) {
        UI.modal('summary-modal', false);
        this.begin(true);  // ËøõÂÖ•ÈîôÈ¢òÈáçÁªÉÊ®°Âºè
      } else {
        UI.modal('summary-modal', false);
        this.begin(false);  // Êó†ÈîôÈ¢òÔºåÊ≠£Â∏∏ÂºÄÂßã
      }
    },
    
    home() {
      UI.show('HOME');
      UI.load();
      UI.el.start.disabled = false;
      UI.el.start.textContent = 'Begin';
    },
    
    updateSpeed() {
      S.mult = parseFloat(UI.el.slider.value);
      const p = Store.get('prefs', {});
      p.mult = S.mult;
      Store.set('prefs', p);
      UI.render();
    },
    
    preview() {
      if (S.speaking) return;
      A.play('The total is forty five dollars and ninety nine cents', this.rate());
    },
    
    playCalib(s) {
      if (S.speaking) return;
      S.speaking = true;
      A.speak('The total is forty five dollars', s === 'A' ? 1.0 : 0.7, false).then(() => {
        S.speaking = false;
      });
    },
    
    selectCalib(c) {
      S.offset = c === 'A' ? 1.0 : 0.85;
      const p = Store.get('prefs', {});
      p.offset = S.offset;
      p.calibrated = true;
      Store.set('prefs', p);
      UI.modal('calibration-modal', false);
      this.begin();
    },
    
    selectLevel(lv) {
      S.level = lv;
      const p = Store.get('prefs', {});
      p.level = lv;
      Store.set('prefs', p);
      UI.updateLevelUI();
      UI.updateRate();
    }
  };

  // ========== EVENTS ==========
  document.addEventListener('DOMContentLoaded', () => {
    UI.init();
    
    // Home
    UI.el.start.addEventListener('click', () => App.start());
    UI.el.settings.addEventListener('click', () => UI.modal('speed-modal', true));
    UI.el.levelList.addEventListener('click', e => {
      const item = e.target.closest('.level-item');
      if (item) App.selectLevel(+item.dataset.level);
    });
    
    // Training
    UI.el.listen.addEventListener('click', () => App.handleListen());
    document.getElementById('submit-btn').addEventListener('click', () => App.submit());
    document.getElementById('exit-btn').addEventListener('click', () => App.exit());
    UI.el.keypad.addEventListener('click', e => {
      const k = e.target.closest('.key');
      if (k && !k.disabled) App.input(k.dataset.val);
    });
    
    // Speed modal
    document.getElementById('speed-slider').addEventListener('input', () => App.updateSpeed());
    document.getElementById('preview-btn').addEventListener('click', () => App.preview());
    document.getElementById('close-speed-modal').addEventListener('click', () => UI.modal('speed-modal', false));
    
    // Accent selection
    document.getElementById('accent-options').addEventListener('click', e => {
      const btn = e.target.closest('.accent-btn');
      if (btn && btn.dataset.accent) {
        A.setAccent(btn.dataset.accent);
        UI.updateAccentUI();
      }
    });
    
    // Summary modal
    document.getElementById('continue-btn').addEventListener('click', () => App.practiceWrong());
    document.getElementById('back-home-btn').addEventListener('click', () => App.closeSummary());
    
    // Calibration modal - ÂõõÊ°£ËØ≠ÈÄüÈÄâÊã©
    document.getElementById('close-calib-modal').addEventListener('click', () => UI.modal('calibration-modal', false));
    for (let i = 0; i < 4; i++) {
      document.getElementById('sample-' + i + '-btn').addEventListener('click', () => App.playCalibSample(i));
      document.getElementById('select-' + i + '-btn').addEventListener('click', () => App.selectCalibSpeed(i));
    }
    
    // Keyboard
    document.addEventListener('keydown', e => {
      if (S.screen === 'HOME') {
        if (e.key === 'Enter') App.start();
        return;
      }
      if (S.screen !== 'TRAIN') return;
      
      if (e.key >= '0' && e.key <= '9') App.input(e.key);
      else if (e.key === '.') App.input('.');
      else if (e.key === 'Backspace') App.input('del');
      else if (e.key === 'Enter') {
        if (S.current && S.current.done) App.next();
        else App.submit();
      }
      else if (e.key === ' ') {
        e.preventDefault();
        App.handleListen();
      }
    });
    
    // Visibility
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        A.syn.cancel();
        S.speaking = false;
        App.clearTimer();
      }
    });
    
    A.init();
  });
})();
</script>
</body>
</html>
